<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì§„ê³µê´€ ìŒê°íšŒ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #18181b 50%, #000000 100%);
      min-height: 100vh;
      color: #ffffff;
    }
    
    .hidden { display: none !important; }
    
    /* ë¡œë”© */
    .loading-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #000000 0%, #18181b 50%, #000000 100%);
      z-index: 9999;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(251, 191, 36, 0.3);
      border-top-color: #fbbf24;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ë„¤ë¹„ê²Œì´ì…˜ */
    .nav {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(245, 158, 11, 0.2);
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 1rem;
    }
    
    .nav-content {
      max-width: 56rem;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .nav-logo {
      height: 2.5rem;
      cursor: pointer;
    }
    
    .nav-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .nav-btn {
      padding: 0.5rem;
      border-radius: 0.5rem;
      background: transparent;
      border: none;
      color: #ffffff;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .nav-btn:hover { background: rgba(255,255,255,0.1); }
    .nav-btn.active { background: #d97706; }
    
    .nav-user {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255,255,255,0.1);
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }
    
    .nav-user i { color: #fbbf24; }
    
    .admin-badge {
      background: #d97706;
      color: white;
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-weight: 600;
    }
    
    .logout-btn {
      background: transparent;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 0.875rem;
    }
    
    .logout-btn:hover { color: #ffffff; }
    
    /* ë©”ì¸ ì»¨í…ì¸  */
    .main {
      max-width: 56rem;
      margin: 0 auto;
      padding: 1.5rem 1rem;
    }
    
    /* ì¹´ë“œ */
    .card {
      background: rgba(24, 24, 27, 0.5);
      border-radius: 1rem;
      padding: 1.25rem;
      border: 1px solid rgba(245, 158, 11, 0.1);
      margin-bottom: 0.75rem;
      transition: all 0.2s;
    }
    
    .card:hover {
      background: rgba(39, 39, 42, 0.5);
      border-color: rgba(245, 158, 11, 0.3);
    }
    
    .card-highlight {
      border: 2px solid rgba(245, 158, 11, 0.5);
    }
    
    /* ë²„íŠ¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
    }
    
    .btn-amber {
      background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
      color: #000000;
      font-weight: 600;
    }
    
    .btn-amber:hover { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
    
    .btn-zinc {
      background: #3f3f46;
      color: #ffffff;
    }
    
    .btn-zinc:hover { background: #52525b; }
    
    .btn-green {
      background: #16a34a;
      color: #ffffff;
    }
    
    .btn-green:hover { background: #22c55e; }
    
    .btn-red {
      background: #dc2626;
      color: #ffffff;
    }
    
    .btn-red:hover { background: #ef4444; }
    
    .btn-sm {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ì¸í’‹ */
    .input-group {
      margin-bottom: 1rem;
    }
    
    .input-label {
      display: block;
      color: #9ca3af;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    
    .input-wrapper {
      position: relative;
    }
    
    .input-wrapper i {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
    }
    
    .input {
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      padding-left: 2.5rem;
      color: #ffffff;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .input:focus {
      outline: none;
      border-color: #f59e0b;
    }
    
    .input::placeholder { color: #6b7280; }
    
    .input-no-icon { padding-left: 1rem; }
    
    /* ë°°ì§€ */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .badge-amber { background: rgba(217, 119, 6, 0.3); color: #fbbf24; }
    .badge-green { background: rgba(22, 163, 74, 0.3); color: #4ade80; }
    .badge-red { background: rgba(220, 38, 38, 0.3); color: #f87171; }
    .badge-gray { background: rgba(63, 63, 70, 0.5); color: #d1d5db; }
    .badge-purple { background: rgba(147, 51, 234, 0.3); color: #c084fc; }
    .badge-yellow { background: rgba(202, 138, 4, 0.3); color: #facc15; }
    
    .badge-solid-amber { background: #d97706; color: #ffffff; }
    .badge-solid-red { background: #dc2626; color: #ffffff; }
    
    /* ëª¨ë‹¬ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1rem;
    }
    
    .modal {
      background: #27272a;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 24rem;
      width: 100%;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .modal-red { border-color: rgba(220, 38, 38, 0.3); }
    
    .modal-icon {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
    }
    
    .modal-icon-amber { background: rgba(217, 119, 6, 0.2); color: #fbbf24; }
    .modal-icon-red { background: rgba(220, 38, 38, 0.2); color: #f87171; }
    .modal-icon-green { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
    
    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    
    .modal-text {
      color: #9ca3af;
      font-size: 0.875rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    .modal-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .modal-actions .btn { flex: 1; }
    
    /* íƒ­ */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      overflow-x: auto;
      padding-bottom: 0.25rem;
    }
    
    .tab {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background: transparent;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .tab:hover { color: #ffffff; }
    .tab.active { background: #d97706; color: #ffffff; }
    
    /* í† ìŠ¤íŠ¸ */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #16a34a;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      z-index: 200;
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateX(-50%) translateY(1rem); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    /* ì•Œë¦¼ ë°°ì§€ */
    .notification-badge {
      position: absolute;
      top: -0.25rem;
      right: -0.25rem;
      background: #ef4444;
      color: white;
      font-size: 0.625rem;
      min-width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    
    /* ë¡œê·¸ì¸ í™”ë©´ */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .login-card {
      background: rgba(24, 24, 27, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 1rem;
      padding: 2rem;
      max-width: 28rem;
      width: 100%;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .login-logo {
      width: 10rem;
      display: block;
      margin: 0 auto 0.5rem;
    }
    
    .login-title {
      font-size: 1rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: 0.1em;
      margin-bottom: 2rem;
    }
    
    .login-hint {
      color: #6b7280;
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    .login-error {
      color: #f87171;
      font-size: 0.875rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    /* í—¤ë” */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .back-btn {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }
    
    .back-btn:hover { background: rgba(255,255,255,0.1); }
    
    /* ì„¸ì…˜ ì¹´ë“œ */
    .session-card {
      cursor: pointer;
    }
    
    .session-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }
    
    .session-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .session-meta {
      display: flex;
      gap: 1rem;
      color: #9ca3af;
      font-size: 0.875rem;
      flex-wrap: wrap;
    }
    
    .session-meta i { margin-right: 0.25rem; }
    
    /* 아코디언 트랙 아이템 */
    .track-item {
      background: rgba(39, 39, 42, 0.3);
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      overflow: hidden;
      transition: all 0.2s;
    }
    
    .track-item:hover {
      background: rgba(39, 39, 42, 0.5);
    }
    
    /* 아코디언 헤더 (항상 표시, 클릭 가능) */
    .track-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      cursor: pointer;
      user-select: none;
    }
    
    .track-number {
      width: 1.5rem;
      height: 1.5rem;
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .track-thumb {
      width: 3rem;
      height: 3rem;
      border-radius: 0.5rem;
      object-fit: cover;
      background: #3f3f46;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }
    
    .track-info { 
      flex: 1; 
      min-width: 0; 
    }
    
    .track-title { 
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    .track-artist { 
      color: #9ca3af; 
      font-size: 0.875rem; 
    }
    
    .track-expand-icon {
      color: #6b7280;
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }
    
    .track-item.expanded .track-expand-icon {
      transform: rotate(180deg);
    }
    
    /* 아코디언 바디 (펼쳤을 때만 표시) */
    .track-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }
    
    .track-body.expanded {
      max-height: 1000px;
      padding: 0 0.75rem 0.75rem 0.75rem;
    }
    
    .track-body-content {
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .track-recommender { 
      color: #9ca3af; 
      font-size: 0.875rem; 
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .track-comment {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      color: #d1d5db;
      font-size: 0.875rem;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .track-comment-empty {
      color: #6b7280;
      font-style: italic;
    }
    
    .track-links {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .track-link {
      flex: 1;
      padding: 0.625rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 500;
      gap: 0.375rem;
      transition: all 0.2s;
    }
    
    .track-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .track-link-youtube { background: #dc2626; color: white; }
    .track-link-spotify { background: #22c55e; color: white; }
    .track-link-apple { background: #ec4899; color: white; }
    
    .track-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    /* íˆ¬í‘œ */
    .vote-section { margin-top: 1rem; }
    
    .vote-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .vote-label {
      width: 4rem;
      font-size: 0.75rem;
      color: #9ca3af;
    }
    
    .vote-stars {
      display: flex;
      gap: 0.25rem;
    }
    
    .vote-star {
      background: none;
      border: none;
      color: #3f3f46;
      cursor: pointer;
      font-size: 1.25rem;
      padding: 0;
      transition: color 0.2s;
    }
    
    .vote-star.active { color: #fbbf24; }
    .vote-star:hover { color: #f59e0b; }
    
    .vote-best-btn {
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #3f3f46;
      background: transparent;
      color: #9ca3af;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .vote-best-btn.active {
      background: #ca8a04;
      border-color: #ca8a04;
      color: white;
    }
    
    /* ì°¸ê°€ìž */
    .participant-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: rgba(63, 63, 70, 0.5);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      margin: 0.125rem;
    }
    
    .participant-host {
      background: rgba(202, 138, 4, 0.3);
      color: #facc15;
    }
    
    /* í†µê³„ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .stat-card {
      background: rgba(39, 39, 42, 0.3);
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fbbf24;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    
    /* ê²°ê³¼ */
    .result-track {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(39, 39, 42, 0.3);
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
    }
    
    .result-rank {
      font-size: 1.25rem;
      font-weight: 700;
      width: 2rem;
    }
    
    .result-rank.gold { color: #fbbf24; }
    .result-rank.silver { color: #d1d5db; }
    .result-rank.bronze { color: #f97316; }
    
    .result-scores {
      display: flex;
      gap: 0.75rem;
      font-size: 0.75rem;
      color: #9ca3af;
    }
    
    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* ë“œëž˜ê·¸ í•¸ë“¤ */
    .drag-handle {
      cursor: grab;
      color: #6b7280;
      padding: 0.25rem;
    }
    
    .drag-handle:active { cursor: grabbing; }
    
    /* ì‹ ì²­ê³¡ */
    .request-item {
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid rgba(220, 38, 38, 0.3);
      border-radius: 0.75rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    
    .request-info {
      margin-bottom: 0.5rem;
    }
    
    .request-title { font-weight: 500; }
    .request-artist { color: #9ca3af; font-size: 0.875rem; }
    .request-by { color: #6b7280; font-size: 0.75rem; }
    
    .request-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    /* ì¹´í…Œê³ ë¦¬ ì„ íƒ */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .category-item {
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(63, 63, 70, 0.5);
      background: rgba(39, 39, 42, 0.3);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .category-item:hover { border-color: rgba(245, 158, 11, 0.3); }
    .category-item.selected { background: rgba(147, 51, 234, 0.3); border-color: #a855f7; }
    
    .category-emoji { font-size: 1.5rem; }
    .category-name { font-size: 0.875rem; margin-top: 0.25rem; }
    
    /* ìš°ìŠ¹ìž */
    .winner-card {
      background: linear-gradient(135deg, rgba(202, 138, 4, 0.2) 0%, rgba(217, 119, 6, 0.1) 100%);
      border: 1px solid rgba(202, 138, 4, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    .winner-trophy {
      font-size: 3rem;
      color: #fbbf24;
      margin-bottom: 0.5rem;
    }
    
    .winner-name {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .winner-track {
      color: #9ca3af;
      font-size: 0.875rem;
    }
    
    /* ê´€ë¦¬ìž ì„¤ì • */
    .admin-section {
      background: rgba(217, 119, 6, 0.1);
      border: 1px solid rgba(217, 119, 6, 0.3);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .admin-section-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #fbbf24;
    }
    
    /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
    .toggle-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .toggle {
      width: 3rem;
      height: 1.5rem;
      background: #3f3f46;
      border-radius: 1rem;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .toggle.active { background: #16a34a; }
    
    .toggle::after {
      content: '';
      position: absolute;
      width: 1.25rem;
      height: 1.25rem;
      background: white;
      border-radius: 50%;
      top: 0.125rem;
      left: 0.125rem;
      transition: transform 0.2s;
    }
    
    .toggle.active::after { transform: translateX(1.5rem); }
    
    /* ëž­í‚¹ */
    .ranking-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: rgba(39, 39, 42, 0.3);
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
    }
    
    .ranking-position {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    
    .ranking-position.gold { background: #fbbf24; color: #000; }
    .ranking-position.silver { background: #d1d5db; color: #000; }
    .ranking-position.bronze { background: #f97316; color: #000; }
    .ranking-position.other { background: #3f3f46; color: #9ca3af; }
    
    .ranking-name { flex: 1; font-weight: 500; }
    .ranking-wins { color: #fbbf24; font-weight: 600; }
  </style>
</head>
<body>
  <!-- ë¡œë”© í™”ë©´ -->
  <div id="loading" class="loading-screen">
    <div class="spinner"></div>
  </div>

  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div id="loginScreen" class="login-screen hidden">
    <div class="login-card">
      <img src="data:image/webp;base64,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" alt="Logo" class="login-logo">
      <h1 class="login-title">GINGONGKWAN</h1>
      
      <div class="input-group">
        <label class="input-label">ì´ë¦„ (ì‹¤ëª…)</label>
        <div class="input-wrapper">
          <i class="fas fa-user"></i>
          <input type="text" id="loginName" class="input" placeholder="í™ê¸¸ë™">
        </div>
      </div>
      
      <div class="input-group">
        <label class="input-label">íœ´ëŒ€í° ë²ˆí˜¸</label>
        <div class="input-wrapper">
          <i class="fas fa-phone"></i>
          <input type="tel" id="loginPhone" class="input" placeholder="010-1234-5678">
        </div>
      </div>
      
      <div class="input-group">
        <label class="input-label">PIN ë²ˆí˜¸ (4ìžë¦¬)</label>
        <div class="input-wrapper">
          <i class="fas fa-hashtag"></i>
          <input type="password" id="loginPin" class="input" placeholder="â€¢â€¢â€¢â€¢" maxlength="4">
        </div>
        <p class="login-hint">ì²˜ìŒì´ì‹œë©´ ìƒˆ PINì„ ìž…ë ¥í•˜ì„¸ìš”. ìž¬ë°©ë¬¸ì‹œ ê¸°ì¡´ PINì„ ìž…ë ¥í•˜ì„¸ìš”.</p>
      </div>
      
      <p id="loginError" class="login-error hidden"></p>
      
      <button id="loginBtn" class="btn btn-amber w-full" style="width:100%">
        <span id="loginBtnText">ìž…ìž¥í•˜ê¸°</span>
        <i id="loginSpinner" class="fas fa-spinner fa-spin hidden"></i>
      </button>
    </div>
  </div>

  <!-- ìŠ¹ì¸ ëŒ€ê¸° ëª¨ë‹¬ -->
  <div id="pendingModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-icon modal-icon-amber">
        <i class="fas fa-clock fa-2x"></i>
      </div>
      <h3 class="modal-title">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</h3>
      <p class="modal-text">ì•„ì§ ê´€ë¦¬ìžì˜ ìŠ¹ì¸ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>ìŠ¹ì¸ í›„ ìž…ìž¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      <button class="btn btn-zinc" style="width:100%" onclick="closePendingModal()">í™•ì¸</button>
    </div>
  </div>

  <!-- ê±°ì ˆ ëª¨ë‹¬ -->
  <div id="rejectedModal" class="modal-overlay hidden">
    <div class="modal modal-red">
      <div class="modal-icon modal-icon-red">
        <i class="fas fa-times fa-2x"></i>
      </div>
      <h3 class="modal-title">ìž…ìž¥ ë¶ˆê°€</h3>
      <p class="modal-text">ë©¤ë²„ ê°€ìž…ì´ ê±°ì ˆëœ ë©¤ë²„ìž…ë‹ˆë‹¤.</p>
      <button class="btn btn-zinc" style="width:100%" onclick="closeRejectedModal()">í™•ì¸</button>
    </div>
  </div>

  <!-- ë©”ì¸ ì•± -->
  <div id="app" class="hidden">
    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="nav">
      <div class="nav-content">
        <img src="data:image/webp;base64,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" alt="Logo" class="nav-logo" onclick="goHome()">
        <div class="nav-right">
          <button class="nav-btn" id="historyBtn" onclick="showHistory()">
            <i class="fas fa-history"></i>
          </button>
          <div id="navNotification" class="hidden" style="position:relative">
            <i class="fas fa-bell" style="color:#fbbf24"></i>
            <span class="notification-badge" id="navNotificationCount">0</span>
          </div>
          <div class="nav-user">
            <i class="fas fa-user"></i>
            <span id="navUserName"></span>
            <span id="navAdminBadge" class="admin-badge hidden">ê´€ë¦¬ìž</span>
          </div>
          <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </nav>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <main class="main" id="mainContent">
      <!-- ë™ì ìœ¼ë¡œ ì½˜í…ì¸  ë Œë”ë§ -->
    </main>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast hidden"></div>

  <script>
    // ==================== ì „ì—­ ìƒíƒœ ====================
    let currentUser = null;
    let allUsers = [];
    let sessions = [];
    let currentView = 'home';
    let selectedSession = null;
    let categories = [];
    let expandedTrackId = null;

    // ==================== ìœ í‹¸ë¦¬í‹° ====================
    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function formatPhone(phone) {
      const cleaned = (phone || '').replace(/\D/g, '');
      if (cleaned.length === 11) {
        return cleaned.slice(0, 3) + '-' + cleaned.slice(3, 7) + '-' + cleaned.slice(7);
      }
      return phone;
    }

    function getMusicLinks(title, artist) {
      const query = encodeURIComponent(title + ' ' + artist);
      return {
        youtube: 'https://www.youtube.com/results?search_query=' + query,
        spotify: 'https://open.spotify.com/search/' + query,
        apple: 'https://music.apple.com/kr/search?term=' + query
      };
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2000);
    }

    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    // ==================== ì´ˆê¸°í™” ====================
    async function init() {
      try {
        const data = await callServer('getAllData');
        allUsers = data.users || [];
        sessions = data.sessions || [];
        categories = data.categories || [];
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìœ ì € í™•ì¸
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
          const user = JSON.parse(savedUser);
          const latestUser = allUsers.find(u => u.id === user.id);
          if (latestUser && latestUser.status === 'approved') {
            currentUser = latestUser;
            showApp();
          } else {
            showLogin();
          }
        } else {
          showLogin();
        }
      } catch (e) {
        console.error('Init error:', e);
        showLogin();
        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        setTimeout(() => {
          showLoginError('ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ' + (e.message || 'ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”'));
        }, 500);
      }
      hideLoading();
    }

    function callServer(functionName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName](...args);
      });
    }

    // ==================== ì¸ì¦ ====================
    function showLogin() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('app').classList.add('hidden');
    }

    function showApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('navUserName').textContent = currentUser.name;
      
      if (currentUser.isAdmin) {
        document.getElementById('navAdminBadge').classList.remove('hidden');
        updateNotificationBadge();
      } else {
        document.getElementById('navAdminBadge').classList.add('hidden');
        document.getElementById('navNotification').classList.add('hidden');
      }
      
      renderHome();
    }

    function updateNotificationBadge() {
      const pendingUsers = allUsers.filter(u => u.status === 'pending').length;
      const pendingRequests = sessions.reduce((sum, s) => {
        return sum + (s.songRequests || []).filter(r => r.status === 'pending').length;
      }, 0);
      const total = pendingUsers + pendingRequests;
      
      if (total > 0) {
        document.getElementById('navNotification').classList.remove('hidden');
        document.getElementById('navNotificationCount').textContent = total;
      } else {
        document.getElementById('navNotification').classList.add('hidden');
      }
    }

    async function handleLogin() {
      const name = document.getElementById('loginName').value.trim();
      const phone = document.getElementById('loginPhone').value.trim();
      const pin = document.getElementById('loginPin').value.trim();
      
      if (!name || !phone || pin.length !== 4) {
        showLoginError('ëª¨ë“  ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ìž…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      setLoginLoading(true);
      
      try {
        const result = await callServer('login', name, phone, pin);
        
        if (result.success) {
          currentUser = result.user;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // ìœ ì € ëª©ë¡ ê°±ì‹ 
          const data = await callServer('getAllData');
          allUsers = data.users || [];
          sessions = data.sessions || [];
          
          showApp();
        } else {
          if (result.error === 'pending') {
            document.getElementById('pendingModal').classList.remove('hidden');
          } else if (result.error === 'rejected') {
            document.getElementById('rejectedModal').classList.remove('hidden');
          } else {
            showLoginError(result.error || result.message);
          }
        }
      } catch (e) {
        showLoginError('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜: ' + (e.message || 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
        console.error(e);
      }
      
      setLoginLoading(false);
    }

    function showLoginError(message) {
      const errorEl = document.getElementById('loginError');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function setLoginLoading(loading) {
      const btn = document.getElementById('loginBtn');
      const text = document.getElementById('loginBtnText');
      const spinner = document.getElementById('loginSpinner');
      
      btn.disabled = loading;
      text.textContent = loading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ìž…ìž¥í•˜ê¸°';
      spinner.classList.toggle('hidden', !loading);
    }

    function closePendingModal() {
      document.getElementById('pendingModal').classList.add('hidden');
    }

    function closeRejectedModal() {
      document.getElementById('rejectedModal').classList.add('hidden');
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      document.getElementById('loginName').value = '';
      document.getElementById('loginPhone').value = '';
      document.getElementById('loginPin').value = '';
      document.getElementById('loginError').classList.add('hidden');
      showLogin();
    }

    // ==================== ë„¤ë¹„ê²Œì´ì…˜ ====================
    function goHome() {
      currentView = 'home';
      selectedSession = null;
      document.getElementById('historyBtn').classList.remove('active');
      renderHome();
    }

    function showHistory() {
      currentView = 'history';
      document.getElementById('historyBtn').classList.add('active');
      renderHistory();
    }

    // ==================== í™ˆ í™”ë©´ ====================
    function renderHome() {
      const main = document.getElementById('mainContent');
      const pendingCount = allUsers.filter(u => u.status === 'pending').length;
      const sortedSessions = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      let html = '<div class="page-header">';
      html += '<h1 class="page-title">ìŒê°íšŒ ëª©ë¡</h1>';
      
      if (currentUser.isAdmin) {
        html += '<div style="display:flex;gap:0.5rem">';
        html += '<button class="btn btn-zinc" onclick="showAdminUsers()" style="position:relative">';
        html += '<i class="fas fa-users"></i> ë©¤ë²„ ê´€ë¦¬';
        if (pendingCount > 0) {
          html += '<span class="notification-badge">' + pendingCount + '</span>';
        }
        html += '</button>';
        html += '<button class="btn btn-amber" onclick="showCreateSession()">';
        html += '<i class="fas fa-plus"></i> ìƒˆ íšŒì°¨';
        html += '</button>';
        html += '</div>';
      }
      html += '</div>';
      
      if (sortedSessions.length === 0) {
        html += '<div class="empty-state">';
        html += '<i class="fas fa-music"></i>';
        html += '<p>ì•„ì§ ë“±ë¡ëœ ìŒê°íšŒê°€ ì—†ìŠµë‹ˆë‹¤</p>';
        html += '</div>';
      } else {
        sortedSessions.forEach(session => {
          const cat = categories.find(c => c.id === session.category) || categories[0];
          const pendingRequests = (session.songRequests || []).filter(r => r.status === 'pending').length;
          
          html += '<div class="card card-hover session-card" onclick="showSession(\'' + session.id + '\')">';
          html += '<div class="session-badges">';
          html += '<span class="badge badge-gray">' + (cat ? cat.emoji + ' ' + cat.name : '') + '</span>';
          html += '<span class="badge badge-purple">' + (session.categoryNumber || 1) + 'íšŒ</span>';
          html += '<span class="badge badge-gray">ì´ ' + (session.totalNumber || 1) + 'íšŒì°¨</span>';
          if (pendingRequests > 0 && currentUser.isAdmin) {
            html += '<span class="badge badge-solid-red">ì‹ ì²­ ' + pendingRequests + '</span>';
          }
          html += '</div>';
          html += '<h3 class="session-title">' + escapeHtml(session.title) + '</h3>';
          html += '<div class="session-meta">';
          html += '<span><i class="fas fa-calendar"></i>' + formatDate(session.date) + '</span>';
          if (session.location) {
            html += '<span><i class="fas fa-map-marker-alt"></i>' + escapeHtml(session.location) + '</span>';
          }
          html += '</div>';
          html += '</div>';
        });
      }
      
      main.innerHTML = html;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ==================== ì„¸ì…˜ ìƒì„¸ ====================
    async function showSession(sessionId) {
      showLoading();
      
      try {
        const sessionData = await callServer('getFullSessionData', sessionId);
        if (sessionData) {
          selectedSession = sessionData;
          currentView = 'session';
          renderSession();
        }
      } catch (e) {
        console.error('Error loading session:', e);
        showToast('ì„¸ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
      
      hideLoading();
    }

    function renderSession() {
      const main = document.getElementById('mainContent');
      const s = selectedSession;
      const cat = categories.find(c => c.id === s.category) || categories[0];
      
      let html = '<div class="page-header">';
      html += '<div style="display:flex;align-items:center;gap:1rem">';
      html += '<button class="back-btn" onclick="goHome()"><i class="fas fa-chevron-left"></i></button>';
      html += '<div>';
      html += '<div style="display:flex;gap:0.5rem;margin-bottom:0.25rem">';
      html += '<span class="badge badge-gray">' + (cat ? cat.emoji + ' ' + cat.name : '') + '</span>';
      html += '<span class="badge badge-purple">' + (s.categoryNumber || 1) + 'íšŒ</span>';
      html += '</div>';
      html += '<h1 class="page-title">' + escapeHtml(s.title) + '</h1>';
      html += '</div>';
      html += '</div>';
      html += '<button class="btn btn-zinc btn-sm" onclick="shareSession()">';
      html += '<i class="fas fa-share-alt"></i>';
      html += '</button>';
      html += '</div>';
      
      // íƒ­
      html += '<div class="tabs" id="sessionTabs">';
      html += '<button class="tab active" onclick="switchTab(\'info\')">ëª¨ìž„ì •ë³´</button>';
      html += '<button class="tab" onclick="switchTab(\'playlist\')">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</button>';
      html += '<button class="tab" onclick="switchTab(\'vote\')">íˆ¬í‘œí•˜ê¸°</button>';
      html += '<button class="tab" onclick="switchTab(\'result\')">ê²°ê³¼</button>';
      html += '</div>';
      
      // íƒ­ ì»¨í…ì¸ 
      html += '<div id="tabContent"></div>';
      
      main.innerHTML = html;
      switchTab('info');
    }

    function switchTab(tabName) {
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('#sessionTabs .tab').forEach((tab, i) => {
        const tabs = ['info', 'playlist', 'vote', 'result'];
        tab.classList.toggle('active', tabs[i] === tabName);
      });
      
      const content = document.getElementById('tabContent');
      
      switch (tabName) {
        case 'info':
          renderInfoTab(content);
          break;
        case 'playlist':
          renderPlaylistTab(content);
          break;
        case 'vote':
          renderVoteTab(content);
          break;
        case 'result':
          renderResultTab(content);
          break;
      }
    }

    function renderInfoTab(container) {
      const s = selectedSession;
      let html = '';
      
      // ìš°ìŠ¹ìž í‘œì‹œ
      if (s.winnerId) {
        html += '<div class="winner-card">';
        html += '<div class="winner-trophy"><i class="fas fa-trophy"></i></div>';
        html += '<div class="winner-name">' + escapeHtml(s.winnerName) + '</div>';
        html += '<div class="winner-track">ì˜¤ëŠ˜ì˜ 1ë“±</div>';
        html += '</div>';
      }
      
      // ê´€ë¦¬ìž ì„¤ì •
      if (currentUser.isAdmin) {
        html += '<div class="admin-section">';
        html += '<div class="admin-section-title"><i class="fas fa-cog"></i> ê´€ë¦¬ìž ì„¤ì •</div>';
        
        // íˆ¬í‘œ í† ê¸€
        html += '<div class="toggle-wrapper">';
        html += '<span>íˆ¬í‘œ í™œì„±í™”</span>';
        html += '<div class="toggle ' + (s.isVotingOpen ? 'active' : '') + '" onclick="toggleVoting()"></div>';
        html += '</div>';
        
        // ë¯¸íˆ¬í‘œìž
        const participants = s.participants || [];
        const odersWhoVoted = new Set((s.votes || []).map(v => v.oderId));
        const notVoted = participants.filter(p => !odersWhoVoted.has(p.id));
        if (notVoted.length > 0) {
          html += '<p style="color:#9ca3af;font-size:0.875rem;margin-top:0.5rem">';
          html += 'ë¯¸íˆ¬í‘œ: ' + notVoted.map(p => p.name).join(', ');
          html += '</p>';
        }
        
        // ì‹ ì²­ê³¡ ìš”ì²­
        const pendingRequests = (s.songRequests || []).filter(r => r.status === 'pending');
        if (pendingRequests.length > 0) {
          html += '<div style="margin-top:1rem">';
          html += '<div class="admin-section-title" style="color:#f87171"><i class="fas fa-envelope"></i> ì‹ ì²­ê³¡ ìš”ì²­ (' + pendingRequests.length + ')</div>';
          pendingRequests.forEach(req => {
            html += '<div class="request-item">';
            html += '<div class="request-info">';
            html += '<div class="request-title">' + escapeHtml(req.title) + '</div>';
            html += '<div class="request-artist">' + escapeHtml(req.artist) + '</div>';
            html += '<div class="request-by">ìš”ì²­: ' + escapeHtml(req.requesterName) + '</div>';
            html += '</div>';
            html += '<div class="request-actions">';
            html += '<button class="btn btn-green btn-sm" onclick="approveSongRequest(\'' + req.id + '\')"><i class="fas fa-check"></i> ìŠ¹ì¸</button>';
            html += '<button class="btn btn-red btn-sm" onclick="rejectSongRequest(\'' + req.id + '\')"><i class="fas fa-times"></i> ê±°ì ˆ</button>';
            html += '</div>';
            html += '</div>';
          });
          html += '</div>';
        }
        
        html += '<div style="display:flex;gap:0.5rem;margin-top:1rem">';
        html += '<button class="btn btn-zinc btn-sm" onclick="editSession()"><i class="fas fa-edit"></i> ìˆ˜ì •</button>';
        html += '<button class="btn btn-red btn-sm" onclick="confirmDeleteSession()"><i class="fas fa-trash"></i> ì‚­ì œ</button>';
        html += '</div>';
        html += '</div>';
      }
      
      // ê¸°ë³¸ ì •ë³´
      html += '<div class="card">';
      html += '<h3 style="font-weight:600;margin-bottom:1rem">ëª¨ìž„ ì •ë³´</h3>';
      html += '<p style="margin-bottom:0.5rem"><i class="fas fa-calendar" style="width:1.5rem;color:#9ca3af"></i> ' + formatDate(s.date) + '</p>';
      if (s.location) {
        html += '<p style="margin-bottom:0.5rem"><i class="fas fa-map-marker-alt" style="width:1.5rem;color:#9ca3af"></i> ' + escapeHtml(s.location) + '</p>';
      }
      if (s.description) {
        html += '<p style="margin-top:1rem;color:#d1d5db">' + escapeHtml(s.description) + '</p>';
      }
      
      // í˜¸ìŠ¤íŠ¸
      const hosts = s.hosts || [];
      if (hosts.length > 0) {
        html += '<p style="margin-top:1rem"><strong>í˜¸ìŠ¤íŠ¸:</strong> ' + hosts.map(h => h.name).join(', ') + '</p>';
      }
      
      // ì°¸ê°€ìž
      const participants = s.participants || [];
      if (participants.length > 0) {
        html += '<div style="margin-top:1rem">';
        html += '<strong>ì°¸ê°€ìž (' + participants.length + 'ëª…)</strong>';
        html += '<div style="margin-top:0.5rem">';
        participants.forEach(p => {
          const isHost = hosts.some(h => h.id === p.id);
          html += '<span class="participant-tag ' + (isHost ? 'participant-host' : '') + '">';
          if (isHost) html += '<i class="fas fa-crown" style="font-size:0.625rem"></i> ';
          html += escapeHtml(p.name);
          html += '</span>';
        });
        html += '</div>';
        html += '</div>';
      }
      html += '</div>';
      
      // ì‹ ì²­ê³¡ ìš”ì²­ ë²„íŠ¼
      if (!currentUser.isAdmin && s.isVotingOpen) {
        html += '<button class="btn btn-zinc" style="width:100%;margin-top:1rem" onclick="showSongRequestModal()">';
        html += '<i class="fas fa-plus-square"></i> ì‹ ì²­ê³¡ ìš”ì²­í•˜ê¸°';
        html += '</button>';
      }
      
      container.innerHTML = html;
    }

    function renderPlaylistTab(container) {
      const tracks = selectedSession.tracks || [];
      let html = '';
      
      if (tracks.length === 0) {
        html = '<div class="empty-state"><i class="fas fa-music"></i><p>아직 등록된 곡이 없습니다</p></div>';
      } else {
        tracks.forEach((track, i) => {
          const links = getMusicLinks(track.title, track.artist);
          const isExpanded = expandedTrackId === track.id;
          
          html += '<div class="track-item ' + (isExpanded ? 'expanded' : '') + '">';
          
          // 아코디언 헤더
          html += '<div class="track-header" onclick="toggleTrack(\'' + track.id + '\')">';
          html += '<div class="track-number">' + (i + 1) + '</div>';
          
          if (track.thumbnail) {
            html += '<img src="' + track.thumbnail + '" class="track-thumb">';
          } else {
            html += '<div class="track-thumb"><i class="fas fa-music"></i></div>';
          }
          
          html += '<div class="track-info">';
          html += '<div class="track-title">' + escapeHtml(track.title) + '</div>';
          html += '<div class="track-artist">' + escapeHtml(track.artist) + '</div>';
          html += '</div>';
          html += '<i class="fas fa-chevron-down track-expand-icon"></i>';
          html += '</div>';
          
          // 아코디언 바디
          html += '<div class="track-body ' + (isExpanded ? 'expanded' : '') + '">';
          html += '<div class="track-body-content">';
          
          if (track.recommenderName) {
            html += '<div class="track-recommender">';
            html += '<i class="fas fa-user-circle"></i> 선곡: ' + escapeHtml(track.recommenderName);
            html += '</div>';
          }
          
          if (track.comment) {
            html += '<div class="track-comment">' + escapeHtml(track.comment) + '</div>';
          } else {
            html += '<div class="track-comment track-comment-empty">선곡자의 변이 없습니다</div>';
          }
          
          html += '<div class="track-links">';
          html += '<a href="' + links.youtube + '" target="_blank" class="track-link track-link-youtube" onclick="event.stopPropagation()"><i class="fab fa-youtube"></i> YouTube</a>';
          html += '<a href="' + links.spotify + '" target="_blank" class="track-link track-link-spotify" onclick="event.stopPropagation()"><i class="fab fa-spotify"></i> Spotify</a>';
          html += '<a href="' + links.apple + '" target="_blank" class="track-link track-link-apple" onclick="event.stopPropagation()"><i class="fab fa-apple"></i> Apple</a>';
          html += '</div>';
          
          const canEdit = currentUser.isAdmin || track.recommenderId === currentUser.id;
          if (canEdit) {
            html += '<div class="track-actions">';
            html += '<button class="btn btn-zinc btn-sm" onclick="event.stopPropagation();editTrackComment(\'' + track.id + '\')"><i class="fas fa-edit"></i> 선곡자의 변 ' + (track.comment ? '수정' : '작성') + '</button>';
            html += '</div>';
          }
          
          html += '</div></div></div>';
        });
      }
      
      // 관리자: 곡 추가
      if (currentUser.isAdmin) {
        html += '<div class="card" style="margin-top:1rem">';
        html += '<h4 style="font-weight:600;margin-bottom:0.75rem">곡 추가</h4>';
        html += '<input type="text" id="newTrackTitle" class="input input-no-icon" placeholder="곡 제목" style="margin-bottom:0.5rem">';
        html += '<input type="text" id="newTrackArtist" class="input input-no-icon" placeholder="아티스트" style="margin-bottom:0.5rem">';
        html += '<select id="newTrackRecommender" class="input input-no-icon" style="margin-bottom:0.5rem">';
        html += '<option value="">추천인 선택</option>';
        (selectedSession.participants || []).forEach(p => {
          html += '<option value="' + p.id + '">' + escapeHtml(p.name) + '</option>';
        });
        html += '</select>';
        html += '<button class="btn btn-amber" style="width:100%" onclick="addTrack()"><i class="fas fa-plus"></i> 곡 추가</button>';
        html += '</div>';
      }
      
      container.innerHTML = html;
    }

    function toggleTrack(trackId) {
      if (expandedTrackId === trackId) {
        expandedTrackId = null;
      } else {
        expandedTrackId = trackId;
      }
      renderPlaylistTab(document.getElementById('tabContent'));
    }
    
    function editTrackComment(trackId) {
      const track = selectedSession.tracks.find(t => t.id === trackId);
      if (!track) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'commentModal';
      modal.innerHTML = '<div class="modal">' +
        '<h3 class="modal-title">선곡자의 변</h3>' +
        '<p class="modal-text" style="text-align:left;margin-bottom:0.5rem"><strong>' + escapeHtml(track.title) + '</strong><br><span style="color:#9ca3af">' + escapeHtml(track.artist) + '</span></p>' +
        '<div class="input-group"><textarea id="commentText" class="input input-no-icon" rows="6" placeholder="이 곡을 선곡한 이유나 곡에 대한 생각을 자유롭게 적어주세요...">' + escapeHtml(track.comment || '') + '</textarea></div>' +
        '<div class="modal-actions">' +
        '<button class="btn btn-zinc" onclick="closeCommentModal()">취소</button>' +
        '<button class="btn btn-amber" onclick="saveTrackComment(\'' + trackId + '\')">저장</button>' +
        '</div></div>';
      document.body.appendChild(modal);
    }
    
    function closeCommentModal() {
      const modal = document.getElementById('commentModal');
      if (modal) modal.remove();
    }
    
    async function saveTrackComment(trackId) {
      const comment = document.getElementById('commentText').value.trim();
      const track = selectedSession.tracks.find(t => t.id === trackId);
      if (!track) return;
      
      track.comment = comment;
      
      showLoading();
      try {
        await callServer('saveTrack', track);
        closeCommentModal();
        showToast('저장되었습니다');
        await showSession(selectedSession.id);
        switchTab('playlist');
      } catch (e) {
        console.error('Save comment error:', e);
        showToast('저장 실패');
      }
      hideLoading();
    }


    function renderVoteTab(container) {
      const s = selectedSession;
      const tracks = s.tracks || [];
      const myVotes = (s.votes || []).filter(v => v.oderId === currentUser.id);
      
      let html = '';
      
      if (!s.isVotingOpen) {
        html = '<div class="empty-state"><i class="fas fa-lock"></i><p>íˆ¬í‘œê°€ ì•„ì§ ì‹œìž‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p></div>';
        container.innerHTML = html;
        return;
      }
      
      if (tracks.length === 0) {
        html = '<div class="empty-state"><i class="fas fa-music"></i><p>íˆ¬í‘œí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
        container.innerHTML = html;
        return;
      }
      
      tracks.forEach((track, i) => {
        const myVote = myVotes.find(v => v.trackId === track.id) || {};
        
        html += '<div class="card" style="margin-bottom:1rem">';
        html += '<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem">';
        html += '<div class="track-number">' + (i + 1) + '</div>';
        html += '<div>';
        html += '<div class="track-title">' + escapeHtml(track.title) + '</div>';
        html += '<div class="track-artist">' + escapeHtml(track.artist) + '</div>';
        html += '</div>';
        html += '</div>';
        
        // ëŒ€ì¤‘ì„± íˆ¬í‘œ
        html += '<div class="vote-row">';
        html += '<span class="vote-label">ëŒ€ì¤‘ì„±</span>';
        html += '<div class="vote-stars">';
        for (let star = 1; star <= 5; star++) {
          html += '<button class="vote-star ' + (myVote.popularity >= star ? 'active' : '') + '" onclick="vote(\'' + track.id + '\', \'popularity\', ' + star + ')">';
          html += '<i class="fas fa-star"></i>';
          html += '</button>';
        }
        html += '</div>';
        html += '</div>';
        
        // ì„ í˜¸ë„ íˆ¬í‘œ
        html += '<div class="vote-row">';
        html += '<span class="vote-label">ì„ í˜¸ë„</span>';
        html += '<div class="vote-stars">';
        for (let star = 1; star <= 5; star++) {
          html += '<button class="vote-star ' + (myVote.preference >= star ? 'active' : '') + '" onclick="vote(\'' + track.id + '\', \'preference\', ' + star + ')">';
          html += '<i class="fas fa-star"></i>';
          html += '</button>';
        }
        html += '</div>';
        html += '</div>';
        
        // ì˜¤ëŠ˜ì˜ 1ë“±
        html += '<div class="vote-row">';
        html += '<span class="vote-label">1ë“±</span>';
        html += '<button class="vote-best-btn ' + (myVote.todayBest ? 'active' : '') + '" onclick="voteBest(\'' + track.id + '\')">';
        html += '<i class="fas fa-trophy"></i> ì˜¤ëŠ˜ì˜ 1ë“±';
        html += '</button>';
        html += '</div>';
        
        html += '</div>';
      });
      
      container.innerHTML = html;
    }

    function renderResultTab(container) {
      const s = selectedSession;
      const tracks = s.tracks || [];
      const votes = s.votes || [];
      
      if (tracks.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-bar"></i><p>ê²°ê³¼ë¥¼ í‘œì‹œí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
        return;
      }
      
      // ì ìˆ˜ ê³„ì‚°
      const trackScores = tracks.map(track => {
        const trackVotes = votes.filter(v => v.trackId === track.id);
        const popularitySum = trackVotes.reduce((sum, v) => sum + (v.popularity || 0), 0);
        const preferenceSum = trackVotes.reduce((sum, v) => sum + (v.preference || 0), 0);
        const todayBestCount = trackVotes.filter(v => v.todayBest).length;
        const totalScore = popularitySum + preferenceSum + (todayBestCount * 10);
        
        return {
          ...track,
          popularitySum,
          preferenceSum,
          todayBestCount,
          totalScore
        };
      }).sort((a, b) => b.totalScore - a.totalScore);
      
      // í†µê³„
      let html = '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="stat-value">' + tracks.length + '</div><div class="stat-label">ì´ ê³¡ìˆ˜</div></div>';
      html += '<div class="stat-card"><div class="stat-value">' + (s.participants || []).length + '</div><div class="stat-label">ì°¸ê°€ìž</div></div>';
      const odersVoted = new Set(votes.map(v => v.oderId)).size;
      html += '<div class="stat-card"><div class="stat-value">' + odersVoted + '</div><div class="stat-label">íˆ¬í‘œìž</div></div>';
      html += '</div>';
      
      // ë¯¸íˆ¬í‘œìž í‘œì‹œ
      const participants = s.participants || [];
      const odersWhoVoted = new Set(votes.map(v => v.oderId));
      const notVoted = participants.filter(p => !odersWhoVoted.has(p.id));
      if (notVoted.length > 0) {
        html += '<p style="color:#9ca3af;font-size:0.875rem;margin-bottom:1rem">';
        html += 'ë¯¸íˆ¬í‘œ: ' + notVoted.map(p => p.name).join(', ');
        html += '</p>';
      }
      
      // ìˆœìœ„
      html += '<h3 style="font-weight:600;margin-bottom:1rem">ìˆœìœ„</h3>';
      
      trackScores.forEach((track, i) => {
        const rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : (i === 2 ? 'bronze' : ''));
        
        html += '<div class="result-track">';
        html += '<div class="result-rank ' + rankClass + '">' + (i + 1) + '</div>';
        html += '<div style="flex:1">';
        html += '<div class="track-title">' + escapeHtml(track.title) + '</div>';
        html += '<div class="track-artist">' + escapeHtml(track.artist) + '</div>';
        html += '<div class="result-scores">';
        html += '<span>ëŒ€ì¤‘ì„±: ' + track.popularitySum + '</span>';
        html += '<span>ì„ í˜¸ë„: ' + track.preferenceSum + '</span>';
        html += '<span>1ë“±: ' + track.todayBestCount + '</span>';
        html += '</div>';
        html += '</div>';
        html += '<div style="font-weight:700;color:#fbbf24;font-size:1.25rem">' + track.totalScore + '</div>';
        html += '</div>';
      });
      
      // ìš°ìŠ¹ìž ì„ ì • ë²„íŠ¼ (ê´€ë¦¬ìž)
      if (currentUser.isAdmin && trackScores.length > 0 && !s.winnerId) {
        const winner = trackScores[0];
        html += '<button class="btn btn-amber" style="width:100%;margin-top:1rem" onclick="selectWinner(\'' + winner.recommenderId + '\', \'' + escapeHtml(winner.recommenderName) + '\')">';
        html += '<i class="fas fa-trophy"></i> ' + escapeHtml(winner.recommenderName) + 'ë‹˜ì„ ìš°ìŠ¹ìžë¡œ ì„ ì •';
        html += '</button>';
      }
      
      container.innerHTML = html;
    }

    // ==================== íˆ¬í‘œ ====================
    async function vote(trackId, voteType, value) {
      const existingVote = (selectedSession.votes || []).find(v => v.trackId === trackId && v.oderId === currentUser.id);
      
      const voteData = {
        id: existingVote?.id,
        sessionId: selectedSession.id,
        trackId: trackId,
        oderId: currentUser.id,
        popularity: existingVote?.popularity || 0,
        preference: existingVote?.preference || 0,
        todayBest: existingVote?.todayBest || false
      };
      
      voteData[voteType] = value;
      
      try {
        await callServer('saveVote', voteData);
        // ì„¸ì…˜ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        await showSession(selectedSession.id);
        switchTab('vote');
      } catch (e) {
        console.error('Vote error:', e);
        showToast('íˆ¬í‘œ ì €ìž¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function voteBest(trackId) {
      // ê¸°ì¡´ todayBest í•´ì œ
      const currentVotes = (selectedSession.votes || []).filter(v => v.oderId === currentUser.id);
      
      for (const v of currentVotes) {
        if (v.todayBest && v.trackId !== trackId) {
          v.todayBest = false;
          await callServer('saveVote', v);
        }
      }
      
      // ìƒˆë¡œìš´ todayBest ì„¤ì •
      const existingVote = currentVotes.find(v => v.trackId === trackId);
      const voteData = {
        id: existingVote?.id,
        sessionId: selectedSession.id,
        trackId: trackId,
        oderId: currentUser.id,
        popularity: existingVote?.popularity || 0,
        preference: existingVote?.preference || 0,
        todayBest: !existingVote?.todayBest
      };
      
      try {
        await callServer('saveVote', voteData);
        await showSession(selectedSession.id);
        switchTab('vote');
      } catch (e) {
        console.error('Vote error:', e);
        showToast('íˆ¬í‘œ ì €ìž¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }

    // ==================== ê´€ë¦¬ìž ê¸°ëŠ¥ ====================
    async function toggleVoting() {
      selectedSession.isVotingOpen = !selectedSession.isVotingOpen;
      
      try {
        await callServer('updateSession', selectedSession);
        showToast(selectedSession.isVotingOpen ? 'íˆ¬í‘œê°€ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤' : 'íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
        renderInfoTab(document.getElementById('tabContent'));
      } catch (e) {
        console.error('Toggle voting error:', e);
        showToast('ì„¤ì • ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function selectWinner(winnerId, winnerName) {
      selectedSession.winnerId = winnerId;
      selectedSession.winnerName = winnerName;
      
      try {
        await callServer('updateSession', selectedSession);
        showToast(winnerName + 'ë‹˜ì´ ìš°ìŠ¹ìžë¡œ ì„ ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        renderResultTab(document.getElementById('tabContent'));
      } catch (e) {
        console.error('Select winner error:', e);
        showToast('ìš°ìŠ¹ìž ì„ ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function addTrack() {
      const title = document.getElementById('newTrackTitle').value.trim();
      const artist = document.getElementById('newTrackArtist').value.trim();
      const recommenderId = document.getElementById('newTrackRecommender').value;
      
      if (!title || !artist || !recommenderId) {
        showToast('ëª¨ë“  ì •ë³´ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      const recommender = (selectedSession.participants || []).find(p => p.id === recommenderId);
      
      const track = {
        sessionId: selectedSession.id,
        title,
        artist,
        recommenderId,
        recommenderName: recommender?.name || ''
      };
      
      try {
        await callServer('saveTrack', track);
        await showSession(selectedSession.id);
        switchTab('playlist');
        showToast('ê³¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('Add track error:', e);
        showToast('ê³¡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function approveSongRequest(requestId) {
      try {
        await callServer('approveSongRequest', requestId, selectedSession.id);
        await showSession(selectedSession.id);
        switchTab('info');
        showToast('ì‹ ì²­ê³¡ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('Approve request error:', e);
        showToast('ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }

    async function rejectSongRequest(requestId) {
      try {
        await callServer('rejectSongRequest', requestId);
        await showSession(selectedSession.id);
        switchTab('info');
        showToast('ì‹ ì²­ê³¡ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤');
      } catch (e) {
        console.error('Reject request error:', e);
        showToast('ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    }

    function shareSession() {
      const s = selectedSession;
      const cat = categories.find(c => c.id === s.category) || categories[0];
      const text = '[' + cat.emoji + ' ' + cat.name + '] ' + s.title + '\n' + formatDate(s.date) + (s.location ? '\nðŸ“ ' + s.location : '') + '\n\n' + window.location.href;
      
      if (navigator.share) {
        navigator.share({ text });
      } else {
        navigator.clipboard.writeText(text);
        showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // ==================== ì„¸ì…˜ ìƒì„± ====================
    function showCreateSession() {
      currentView = 'create-session';
      const main = document.getElementById('mainContent');
      
      const nums = calcSessionNumbers('monthly');
      
      let html = '<div class="page-header">';
      html += '<div style="display:flex;align-items:center;gap:1rem">';
      html += '<button class="back-btn" onclick="goHome()"><i class="fas fa-chevron-left"></i></button>';
      html += '<h1 class="page-title">ìƒˆ íšŒì°¨ ë§Œë“¤ê¸°</h1>';
      html += '</div></div>';
      
      html += '<div class="card"><h3 style="font-weight:600;margin-bottom:0.75rem">ì¹´í…Œê³ ë¦¬</h3>';
      html += '<div class="category-grid">';
      categories.forEach((cat, i) => {
        html += '<div class="category-item ' + (i === 0 ? 'selected' : '') + '" data-category="' + cat.id + '" onclick="selectCategory(\'' + cat.id + '\')">';
        html += '<div class="category-emoji">' + cat.emoji + '</div>';
        html += '<div class="category-name">' + cat.name + '</div></div>';
      });
      html += '</div>';
      html += '<p id="sessionNumbers" style="color:#9ca3af;font-size:0.875rem;text-align:center;margin-top:0.5rem">' + categories[0].name + ' ' + nums.categoryNumber + 'íšŒ | ì „ì²´ ' + nums.totalNumber + 'íšŒì°¨</p></div>';
      
      html += '<div class="card"><h3 style="font-weight:600;margin-bottom:0.75rem">ê¸°ë³¸ ì •ë³´</h3>';
      html += '<div class="input-group"><label class="input-label">ì œëª©</label>';
      html += '<input type="text" id="sessionTitle" class="input input-no-icon" placeholder="ìŒê°íšŒ ì œëª©"></div>';
      html += '<div class="input-group"><label class="input-label">ë‚ ì§œ</label>';
      html += '<input type="date" id="sessionDate" class="input input-no-icon"></div>';
      html += '<div class="input-group"><label class="input-label">ìž¥ì†Œ</label>';
      html += '<input type="text" id="sessionLocation" class="input input-no-icon" placeholder="ëª¨ìž„ ìž¥ì†Œ"></div>';
      html += '<div class="input-group"><label class="input-label">ì„¤ëª…</label>';
      html += '<textarea id="sessionDescription" class="input input-no-icon" rows="3" placeholder="ê°„ë‹¨í•œ ì„¤ëª…"></textarea></div></div>';
      
      html += '<div class="card"><h3 style="font-weight:600;margin-bottom:0.75rem">ì°¸ê°€ìž ì„ íƒ</h3><div id="participantsList">';
      allUsers.filter(u => u.status === 'approved').forEach(user => {
        html += '<label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem;cursor:pointer">';
        html += '<input type="checkbox" class="participant-checkbox" value="' + user.id + '" data-name="' + escapeHtml(user.name) + '">';
        html += '<span>' + escapeHtml(user.name) + '</span></label>';
      });
      html += '</div></div>';
      html += '<button class="btn btn-amber" style="width:100%;margin-top:1rem" onclick="createSession()"><i class="fas fa-plus"></i> íšŒì°¨ ìƒì„±</button>';
      
      main.innerHTML = html;
      document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
    }

    let selectedCategory = 'monthly';

    function selectCategory(categoryId) {
      selectedCategory = categoryId;
      document.querySelectorAll('.category-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.category === categoryId);
      });
      const nums = calcSessionNumbers(categoryId);
      const cat = categories.find(c => c.id === categoryId);
      document.getElementById('sessionNumbers').textContent = cat.name + ' ' + nums.categoryNumber + 'íšŒ | ì „ì²´ ' + nums.totalNumber + 'íšŒì°¨';
    }

    function calcSessionNumbers(categoryId) {
      return { totalNumber: sessions.length + 1, categoryNumber: sessions.filter(s => s.category === categoryId).length + 1 };
    }

    async function createSession() {
      const title = document.getElementById('sessionTitle').value.trim();
      const date = document.getElementById('sessionDate').value;
      if (!title || !date) { showToast('ì œëª©ê³¼ ë‚ ì§œë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      
      const participants = [];
      document.querySelectorAll('.participant-checkbox:checked').forEach(cb => {
        participants.push({ id: cb.value, name: cb.dataset.name });
      });
      
      const nums = calcSessionNumbers(selectedCategory);
      const session = {
        id: generateId(), title, date,
        location: document.getElementById('sessionLocation').value.trim(),
        description: document.getElementById('sessionDescription').value.trim(),
        category: selectedCategory, categoryNumber: nums.categoryNumber, totalNumber: nums.totalNumber,
        isVotingOpen: false, participants, hosts: [], createdAt: new Date().toISOString()
      };
      
      showLoading();
      try {
        await callServer('saveSession', session);
        const data = await callServer('getAllData');
        sessions = data.sessions || [];
        showToast('íšŒì°¨ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
        goHome();
      } catch (e) { showToast('íšŒì°¨ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    // ==================== ì„¸ì…˜ ìˆ˜ì •/ì‚­ì œ ====================
    function editSession() {
      const s = selectedSession;
      const main = document.getElementById('mainContent');
      
      let html = '<div class="page-header"><div style="display:flex;align-items:center;gap:1rem">';
      html += '<button class="back-btn" onclick="showSession(\'' + s.id + '\')"><i class="fas fa-chevron-left"></i></button>';
      html += '<h1 class="page-title">íšŒì°¨ ìˆ˜ì •</h1></div></div>';
      
      html += '<div class="card"><h3 style="font-weight:600;margin-bottom:0.75rem">ê¸°ë³¸ ì •ë³´</h3>';
      html += '<div class="input-group"><label class="input-label">ì œëª©</label>';
      html += '<input type="text" id="editTitle" class="input input-no-icon" value="' + escapeHtml(s.title) + '"></div>';
      html += '<div class="input-group"><label class="input-label">ë‚ ì§œ</label>';
      html += '<input type="date" id="editDate" class="input input-no-icon" value="' + s.date + '"></div>';
      html += '<div class="input-group"><label class="input-label">ìž¥ì†Œ</label>';
      html += '<input type="text" id="editLocation" class="input input-no-icon" value="' + escapeHtml(s.location || '') + '"></div>';
      html += '<div class="input-group"><label class="input-label">ì„¤ëª…</label>';
      html += '<textarea id="editDescription" class="input input-no-icon" rows="3">' + escapeHtml(s.description || '') + '</textarea></div></div>';
      
      html += '<button class="btn btn-amber" style="width:100%;margin-top:1rem" onclick="saveEditSession()"><i class="fas fa-save"></i> ì €ìž¥</button>';
      main.innerHTML = html;
    }

    async function saveEditSession() {
      selectedSession.title = document.getElementById('editTitle').value.trim();
      selectedSession.date = document.getElementById('editDate').value;
      selectedSession.location = document.getElementById('editLocation').value.trim();
      selectedSession.description = document.getElementById('editDescription').value.trim();
      
      showLoading();
      try {
        await callServer('updateSession', selectedSession);
        const data = await callServer('getAllData');
        sessions = data.sessions || [];
        showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
        showSession(selectedSession.id);
      } catch (e) { showToast('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    function confirmDeleteSession() {
      if (confirm('ì •ë§ ì´ íšŒì°¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        deleteSessionConfirmed();
      }
    }

    async function deleteSessionConfirmed() {
      showLoading();
      try {
        await callServer('deleteSession', selectedSession.id);
        const data = await callServer('getAllData');
        sessions = data.sessions || [];
        showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
        goHome();
      } catch (e) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    // ==================== ë©¤ë²„ ê´€ë¦¬ ====================
    function showAdminUsers() {
      currentView = 'admin-users';
      renderAdminUsers();
    }

    function renderAdminUsers() {
      const main = document.getElementById('mainContent');
      const pendingCount = allUsers.filter(u => u.status === 'pending').length;
      const sortedUsers = [...allUsers].sort((a, b) => {
        if (a.status === 'pending' && b.status !== 'pending') return -1;
        if (a.status !== 'pending' && b.status === 'pending') return 1;
        return 0;
      });
      
      let html = '<div class="page-header"><div style="display:flex;align-items:center;gap:1rem">';
      html += '<button class="back-btn" onclick="goHome()"><i class="fas fa-chevron-left"></i></button>';
      html += '<h1 class="page-title">ë©¤ë²„ ê´€ë¦¬</h1>';
      if (pendingCount > 0) html += '<span class="badge badge-solid-red">' + pendingCount + 'ëª… ëŒ€ê¸°</span>';
      html += '</div></div>';
      
      // ìƒˆ ë©¤ë²„ ì¶”ê°€
      html += '<div class="card"><h3 style="font-weight:600;margin-bottom:0.75rem">ìƒˆ ë©¤ë²„ ì¶”ê°€</h3>';
      html += '<input type="text" id="newUserName" class="input input-no-icon" placeholder="ì´ë¦„" style="margin-bottom:0.5rem">';
      html += '<input type="tel" id="newUserPhone" class="input input-no-icon" placeholder="ì „í™”ë²ˆí˜¸" style="margin-bottom:0.5rem">';
      html += '<button class="btn btn-amber" style="width:100%" onclick="addNewUser()"><i class="fas fa-plus"></i> ë©¤ë²„ ì¶”ê°€</button>';
      html += '<div id="newUserPin"></div></div>';
      
      // ê²€ìƒ‰
      html += '<div class="input-wrapper" style="margin-bottom:1rem"><i class="fas fa-search"></i>';
      html += '<input type="text" id="userSearch" class="input" placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰" oninput="filterUsers()"></div>';
      
      // ë©¤ë²„ ëª©ë¡
      html += '<div id="usersList">';
      sortedUsers.forEach(user => {
        html += renderUserCard(user);
      });
      html += '</div>';
      
      main.innerHTML = html;
    }

    function renderUserCard(user) {
      let html = '<div class="card ' + (user.status === 'pending' ? 'card-highlight' : '') + '" style="margin-bottom:0.75rem">';
      html += '<div style="display:flex;justify-content:space-between;align-items:flex-start">';
      html += '<div style="flex:1">';
      html += '<div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.25rem">';
      html += '<span style="font-weight:500">' + escapeHtml(user.name) + '</span>';
      if (user.status === 'pending') html += '<span class="badge badge-amber">ìŠ¹ì¸ëŒ€ê¸°</span>';
      if (user.status === 'rejected') html += '<span class="badge badge-red">ê±°ì ˆë¨</span>';
      if (user.isAdmin) html += '<span class="badge badge-solid-amber"><i class="fas fa-shield-alt"></i> ê´€ë¦¬ìž</span>';
      html += '</div>';
      html += '<div style="color:#9ca3af;font-size:0.875rem">' + formatPhone(user.phone) + '</div>';
      html += '</div>';
      html += '<div style="display:flex;gap:0.5rem">';
      
      if (user.status === 'pending') {
        html += '<button class="btn btn-green btn-sm" onclick="approveUserAction(\'' + user.id + '\')"><i class="fas fa-check"></i></button>';
        html += '<button class="btn btn-red btn-sm" onclick="rejectUserAction(\'' + user.id + '\')"><i class="fas fa-times"></i></button>';
      } else if (user.status === 'rejected') {
        html += '<button class="btn btn-green btn-sm" onclick="approveUserAction(\'' + user.id + '\')"><i class="fas fa-check"></i></button>';
      }
      
      if (user.id !== currentUser.id && user.status !== 'pending') {
        html += '<button class="btn btn-zinc btn-sm" onclick="toggleAdminAction(\'' + user.id + '\')" title="ê´€ë¦¬ìž ê¶Œí•œ"><i class="fas fa-shield-alt"></i></button>';
      }
      html += '<button class="btn btn-zinc btn-sm" onclick="copyUserInfo(\'' + user.id + '\')" title="ì •ë³´ ë³µì‚¬"><i class="fas fa-copy"></i></button>';
      if (user.id !== currentUser.id) {
        html += '<button class="btn btn-red btn-sm" onclick="confirmDeleteUser(\'' + user.id + '\', \'' + escapeHtml(user.name) + '\')" title="ì‚­ì œ"><i class="fas fa-trash"></i></button>';
      }
      html += '</div></div></div>';
      return html;
    }

    function filterUsers() {
      const query = document.getElementById('userSearch').value.toLowerCase();
      const filtered = allUsers.filter(u => u.name.toLowerCase().includes(query) || u.phone.includes(query));
      filtered.sort((a, b) => {
        if (a.status === 'pending' && b.status !== 'pending') return -1;
        if (a.status !== 'pending' && b.status === 'pending') return 1;
        return 0;
      });
      document.getElementById('usersList').innerHTML = filtered.map(u => renderUserCard(u)).join('');
    }

    async function addNewUser() {
      const name = document.getElementById('newUserName').value.trim();
      const phone = document.getElementById('newUserPhone').value.trim();
      if (!name || !phone) { showToast('ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      
      showLoading();
      try {
        const result = await callServer('addUserByAdmin', name, phone);
        if (result.success) {
          document.getElementById('newUserPin').innerHTML = '<div class="card" style="background:rgba(22,163,74,0.2);border-color:rgba(22,163,74,0.3);margin-top:0.5rem;text-align:center"><p style="color:#4ade80;margin-bottom:0.5rem">PINì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤</p><p style="font-size:1.5rem;font-weight:700;letter-spacing:0.2em">' + result.pin + '</p></div>';
          document.getElementById('newUserName').value = '';
          document.getElementById('newUserPhone').value = '';
          const data = await callServer('getAllData');
          allUsers = data.users || [];
          renderAdminUsers();
        } else {
          showToast(result.error || 'ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      } catch (e) { showToast('ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    async function approveUserAction(userId) {
      showLoading();
      try {
        await callServer('approveUser', userId);
        const data = await callServer('getAllData');
        allUsers = data.users || [];
        showToast('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
        renderAdminUsers();
        updateNotificationBadge();
      } catch (e) { showToast('ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    async function rejectUserAction(userId) {
      showLoading();
      try {
        await callServer('rejectUser', userId);
        const data = await callServer('getAllData');
        allUsers = data.users || [];
        showToast('ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤');
        renderAdminUsers();
        updateNotificationBadge();
      } catch (e) { showToast('ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    async function toggleAdminAction(userId) {
      showLoading();
      try {
        await callServer('toggleAdmin', userId);
        const data = await callServer('getAllData');
        allUsers = data.users || [];
        renderAdminUsers();
      } catch (e) { showToast('ê¶Œí•œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    function copyUserInfo(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (user) {
        const text = 'ì´ë¦„: ' + user.name + '\nì „í™”ë²ˆí˜¸: ' + formatPhone(user.phone) + '\nPIN: ' + user.pin;
        navigator.clipboard.writeText(text);
        showToast('ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function confirmDeleteUser(userId, userName) {
      const password = prompt(userName + 'ë‹˜ì„ ì‚­ì œí•˜ë ¤ë©´ ê´€ë¦¬ìž ë¹„ë°€ë²ˆí˜¸ë¥¼ ìž…ë ¥í•˜ì„¸ìš”:');
      if (password) deleteUserAction(userId, password);
    }

    async function deleteUserAction(userId, password) {
      showLoading();
      try {
        const result = await callServer('deleteUserWithPassword', userId, password);
        if (result.success) {
          const data = await callServer('getAllData');
          allUsers = data.users || [];
          showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
          renderAdminUsers();
        } else {
          showToast(result.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      } catch (e) { showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    // ==================== ížˆìŠ¤í† ë¦¬ ====================
    async function renderHistory() {
      const main = document.getElementById('mainContent');
      showLoading();
      
      try {
        const data = await callServer('getHistory');
        const completedSessions = data.sessions || [];
        const rankings = data.rankings || [];
        
        let html = '<div class="page-header">';
        html += '<h1 class="page-title">ì—­ëŒ€ ìŒê°íšŒ</h1></div>';
        
        // ëž­í‚¹
        if (rankings.length > 0) {
          html += '<div class="card" style="margin-bottom:1.5rem">';
          html += '<h3 style="font-weight:600;margin-bottom:1rem"><i class="fas fa-trophy" style="color:#fbbf24;margin-right:0.5rem"></i>ìš°ìŠ¹ ëž­í‚¹</h3>';
          rankings.forEach((r, i) => {
            const posClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : (i === 2 ? 'bronze' : 'other'));
            html += '<div class="ranking-item">';
            html += '<div class="ranking-position ' + posClass + '">' + (i + 1) + '</div>';
            html += '<div class="ranking-name">' + escapeHtml(r.name) + '</div>';
            html += '<div class="ranking-wins">' + r.wins + 'íšŒ</div>';
            html += '</div>';
          });
          html += '</div>';
        }
        
        // ì™„ë£Œëœ ì„¸ì…˜
        html += '<h3 style="font-weight:600;margin-bottom:1rem">ì™„ë£Œëœ ìŒê°íšŒ</h3>';
        if (completedSessions.length === 0) {
          html += '<div class="empty-state"><i class="fas fa-history"></i><p>ì•„ì§ ì™„ë£Œëœ ìŒê°íšŒê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
        } else {
          completedSessions.forEach(s => {
            const cat = categories.find(c => c.id === s.category) || categories[0];
            html += '<div class="card" onclick="showSession(\'' + s.id + '\')" style="cursor:pointer">';
            html += '<div style="display:flex;gap:0.5rem;margin-bottom:0.5rem">';
            html += '<span class="badge badge-gray">' + cat.emoji + ' ' + cat.name + '</span>';
            html += '<span class="badge badge-yellow"><i class="fas fa-trophy"></i> ' + escapeHtml(s.winnerName) + '</span>';
            html += '</div>';
            html += '<h4 style="font-weight:600">' + escapeHtml(s.title) + '</h4>';
            html += '<p style="color:#9ca3af;font-size:0.875rem">' + formatDate(s.date) + '</p>';
            html += '</div>';
          });
        }
        
        main.innerHTML = html;
      } catch (e) {
        console.error('History error:', e);
        main.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>ížˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p></div>';
      }
      
      hideLoading();
    }

    // ==================== ì‹ ì²­ê³¡ ====================
    function showSongRequestModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'songRequestModal';
      modal.innerHTML = '<div class="modal">' +
        '<h3 class="modal-title">ì‹ ì²­ê³¡ ìš”ì²­</h3>' +
        '<div class="input-group"><label class="input-label">ê³¡ ì œëª©</label>' +
        '<input type="text" id="reqTitle" class="input input-no-icon" placeholder="ê³¡ ì œëª©"></div>' +
        '<div class="input-group"><label class="input-label">ì•„í‹°ìŠ¤íŠ¸</label>' +
        '<input type="text" id="reqArtist" class="input input-no-icon" placeholder="ì•„í‹°ìŠ¤íŠ¸"></div>' +
        '<div class="modal-actions">' +
        '<button class="btn btn-zinc" onclick="closeSongRequestModal()">ì·¨ì†Œ</button>' +
        '<button class="btn btn-amber" onclick="submitSongRequest()">ìš”ì²­í•˜ê¸°</button>' +
        '</div></div>';
      document.body.appendChild(modal);
    }

    function closeSongRequestModal() {
      const modal = document.getElementById('songRequestModal');
      if (modal) modal.remove();
    }

    async function submitSongRequest() {
      const title = document.getElementById('reqTitle').value.trim();
      const artist = document.getElementById('reqArtist').value.trim();
      if (!title || !artist) { showToast('ê³¡ ì œëª©ê³¼ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      
      const request = {
        sessionId: selectedSession.id,
        title, artist,
        requesterId: currentUser.id,
        requesterName: currentUser.name,
        status: 'pending'
      };
      
      showLoading();
      try {
        await callServer('saveSongRequest', request);
        closeSongRequestModal();
        showToast('ì‹ ì²­ê³¡ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤');
        await showSession(selectedSession.id);
      } catch (e) { showToast('ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'); }
      hideLoading();
    }

    // ==================== PIN ìž…ë ¥ ì œí•œ ====================
    document.getElementById('loginPin').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
    });

    // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
    document.getElementById('loginBtn').addEventListener('click', handleLogin);

    // ì—”í„°í‚¤ ë¡œê·¸ì¸
    document.querySelectorAll('#loginScreen input').forEach(input => {
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
      });
    });

    // ì´ˆê¸°í™”
    init();
  </script>
</body>
</html>
